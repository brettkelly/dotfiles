#!/bin/zsh

# Script to geolocate an IP address using ipinfo.io
# Usage: ./geoip.sh <IP_ADDRESS>

# Check if an IP address was provided
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <IP_ADDRESS>"
    echo "Example: $0 8.8.8.8"
    exit 1
fi

# Get the IP address from the first argument
ip_address="$1"

# Basic IP address validation (simple regex)
if [[ ! $ip_address =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    echo "Error: '$ip_address' does not appear to be a valid IPv4 address"
    exit 1
fi

# Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required but not installed."
    echo "Install it with: brew install jq (macOS) or sudo apt install jq (Ubuntu/Debian)"
    exit 1
fi

# Make the API call and display results
echo "Looking up geolocation for IP: $ip_address"
echo "----------------------------------------"

response=$(curl -s "https://ipinfo.io/$ip_address/json")

# Check if curl was successful
if [[ $? -ne 0 ]]; then
    echo "Error: Failed to fetch data from ipinfo.io"
    exit 1
fi

# Check if the response contains an error
if echo "$response" | jq -e '.error' &> /dev/null; then
    echo "Error from API:"
    echo "$response" | jq -r '.error'
    exit 1
fi

# Display the formatted results
echo "$response" | jq '.'
